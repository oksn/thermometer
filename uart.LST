C51 COMPILER V7.06   UART                                                                  02/19/2020 11:27:53 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN uart.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE uart.c COMPACT BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          #include <uart.h>
   2          #include <register.h>
   3          #define FOSC      11059200L
   4          #define BAUD    9600
   5          
   6          //extern
   7          
   8          //独立波特率发生器初值,1T模式
   9          //Fosc = 晶振频率, Baud0 = 标准波特率
  10          //RELOAD = 256 - INT(Fosc/Baud0/32 + 0.5)
  11          //Baud = Fosc/(256 - RELOAD)/32
  12          //error = (Baud - Baud0)/Baud0 * 100%
  13          
  14          uchar RELOAD = 0xdc;                    //Fosc = 12MHz, Baud0 = 9600
  15          uchar UART1_Recv_Val = 0;
  16          //uchar UART2_Recv_Val = 0;
  17          
  18          extern unsigned  int idata js;
  19          uchar flag1 = 0;
  20          extern uchar flag2;
  21          //extern unsigned  int idata js;
  22          extern unsigned char UART2_len;
  23          extern unsigned char UART2_Rec[150];
  24          //波特率是否加倍，0不倍，1加倍
  25          bit doubleBaud = 0;
  26          
  27          //独立波特率发生器,0为12T模式，1为1T模式
  28          bit timeMod = 1;
  29          
  30          
  31          
  32          /*
  33           * 函 数 名：UART1_Init
  34          27. * 功能描述：串口1初始化
  35          28. * 输入参数：RELOAD:BRT初值；
  36          29. *           doubleBaud:0波特率不加倍，1波特率加倍
  37          30. *           timeMod:0独立波特率发生器12T模式，1为1T模式
  38          31. * 返 回 值：无
  39           */
  40          void UART1_Init ( uchar RELOAD, bit doubleBaud, bit timeMod )
  41          {
  42   1          SCON |= 0x50;       //串口1方式1,接收充许
  43   1      
  44   1          BRT = RELOAD;       //波特率2400
  45   1      
  46   1          if ( timeMod == 1 )     //1T
  47   1          {
  48   2              //T0x12   T1x12   UM0x6   BRTR    S2SMOD  BRTx12  EXTRAM  S1BRS
  49   2              AUXR |= 0x15;       //串口1使用独立波特率发生器，独立波特率发生器1T
  50   2          }
  51   1          else                    //12T
  52   1          {
  53   2              AUXR |= 0x11;
  54   2          }
  55   1      
C51 COMPILER V7.06   UART                                                                  02/19/2020 11:27:53 PAGE 2   

  56   1          if ( doubleBaud == 1 )
  57   1          {
  58   2              PCON |= 0x80;     //波特率加倍
  59   2          }
  60   1          else
  61   1          {
  62   2              PCON &= 0x7F;     //波特率不加倍
  63   2          }
  64   1      
  65   1          EA = 1;
  66   1          ES = 1;             //充许串口1中断
  67   1      }
  68          
  69          
  70          /*
  71           * 函 数 名：UART2_Init
  72           * 功能描述：串口2初始化
  73           * 输入参数：RELOAD:BRT初值；
  74           *           doubleBaud:0波特率不加倍，1波特率加倍
  75           *           timeMod:0独立波特率发生器12T模式，1为1T模式
  76           * 返 回 值：无
  77           */
  78          void UART2_Init ( uchar RELOAD, bit doubleBaud, bit timeMod )
  79          {
  80   1          //S2SM0  S2SM1   S2SM2   S2REN   S2TB8   S2RB8   S2TI     S2RI
  81   1          S2CON |= 0x50;      //串口2,方式1，接收充许
  82   1      
  83   1          BRT = RELOAD;
  84   1      
  85   1          if ( timeMod == 1 )     //1T
  86   1          {
  87   2              //T0x12   T1x12   UM0x6   BRTR    S2SMOD  BRTx12  EXTRAM  S1BRS
  88   2              AUXR |= 0x14;       //串口1使用独立波特率发生器，独立波特率发生器1T
  89   2          }
  90   1          else                    //12T
  91   1          {
  92   2              AUXR = ( AUXR | 0x10 ) & 0xFB;
  93   2          }
  94   1      
  95   1          if ( doubleBaud == 1 )
  96   1          {
  97   2              AUXR |= 0x08;       //波特率加倍
  98   2          }
  99   1          else
 100   1          {
 101   2              AUXR &= 0xF7;       //波特率不加倍
 102   2          }
 103   1          AUXR1 |= 0x10;   // 将串口2切换到P4口
 104   1          EA = 1;
 105   1          //-       -       -       -       -       -       ESPI    ES2
 106   1          IE2 |= 0x01;            //充许串口2中断
 107   1      }
 108          
 109          
 110          /*
 111           * 函 数 名：UART1_SendOneChar
 112           * 功能描述：串口1发送一个字符
 113           * 输入参数：val:要发送的字符
 114           * 返 回 值：无
 115           */
 116          void UART1_SendOneChar ( uchar val )
 117          {
C51 COMPILER V7.06   UART                                                                  02/19/2020 11:27:53 PAGE 3   

 118   1          ES = 0;                   //关闭串口1中断
 119   1      
 120   1          SBUF = val;
 121   1          while ( TI == 0 );
 122   1          TI = 0;
 123   1      
 124   1          ES = 1;                  //恢复串口1中断
 125   1      }
 126          
 127          
 128          /*
 129           * 函 数 名：UART2_SendOneChar
 130           * 功能描述：串口2发送一个字符
 131           * 输入参数：val:要发送的字符
 132           * 返 回 值：无
 133           */
 134          void UART2_SendOneChar ( uchar val )
 135          {
 136   1          IE2 = 0x00;                 //关闭串口2中断
 137   1      
 138   1          S2BUF = val;
 139   1          while ( ( S2CON & 0x02 ) == 0 );
 140   1          S2CON &= 0xFD;
 141   1      
 142   1          IE2 = 0x01;                //恢复串口2中断
 143   1      }
 144          
 145          
 146          /*
 147           * 函 数 名：UART1_SendStr
 148           * 功能描述：串口1发送字符串
 149           * 输入参数：str:指向要发送的字符串的指针
 150           * 返 回 值：无
 151           */
 152          void UART1_SendStr ( uchar *str )
 153          {
 154   1          while ( ( *str ) != '\0' )
 155   1          {
 156   2              UART1_SendOneChar ( *str );
 157   2              str++;
 158   2          }
 159   1      }
 160          
 161          
 162          /*
 163           * 函 数 名：UART2_SendStr
 164           * 功能描述：串口2发送字符串
 165           * 输入参数：str:指向要发送的字符串的指针
 166           * 返 回 值：无
 167           */
 168          void UART2_SendStr ( uchar *str )
 169          {
 170   1          while ( ( *str ) != '\0' )
 171   1          {
 172   2              UART2_SendOneChar ( *str );
 173   2              str++;
 174   2          }
 175   1      }
 176          
 177          /*
 178          172. * 函 数 名：UART1_Int
 179          173. * 功能描述：串口1中断服务程序，接收串口1字符
C51 COMPILER V7.06   UART                                                                  02/19/2020 11:27:53 PAGE 4   

 180          174. * 输入参数：无
 181          175. * 返 回 值：无
 182           */
 183          void UART1_Int ( void ) interrupt 4
 184          {
 185   1      
 186   1          if ( RI == 1 )
 187   1          {
 188   2              RI = 0;
 189   2              UART1_Recv_Val = SBUF;
 190   2              CO2_data[js] = UART1_Recv_Val;
 191   2              flag1 = 1;
 192   2              if ( js >= 1 )
 193   2              {
 194   3                  if  ( ( CO2_data[js-1] == 0xff ) && ( CO2_data[js] == 0x86 ) )
 195   3                  {
 196   4                      js = 1;
 197   4                  }
 198   3              }
 199   2              js++;
 200   2              if  ( js >= 9 )
 201   2              {
 202   3                  js = 0;
 203   3              }
 204   2              //          UART2_SendOneChar( UART1_Recv_Val);
 205   2          }
 206   1      }
 207          
 208          /*
 209           * 函 数 名：UART2_Int
 210           * 功能描述：串口2中断服务程序，接收串口2字符
 211           * 输入参数：无
 212           * 返 回 值：无
 213           */
 214          void UART2_Int ( void ) interrupt 8
 215          {
 216   1      
 217   1      
 218   1      //  idata unsigned  char indata[20];
 219   1          if ( ( S2CON & 0x01 ) == 1 )
 220   1          {
 221   2              S2CON &= 0xFE;
 222   2              //   flag2 = 0;
 223   2              UART2_Rec[UART2_len] = S2BUF;
 224   2             // UART1_SendOneChar ( S2BUF );
 225   2              if ( UART2_len >= 150 )
 226   2              {
 227   3                  UART2_len = 0;
 228   3              }
 229   2              else
 230   2              {
 231   3      
 232   3                  if  ( UART2_len > 1 ) //判断接收长度不为0的情况
 233   3                  {
 234   4                      if  ( ( UART2_Rec[UART2_len-1] == 0x0d ) && ( UART2_Rec[UART2_len] == 0x0a ) )
 235   4                      {
 236   5                          flag2++;   //计算接收回车换行的次数
 237   5                      }
 238   4                  }
 239   3      
 240   3                  UART2_len++;
 241   3      //           flag2=3;
C51 COMPILER V7.06   UART                                                                  02/19/2020 11:27:53 PAGE 5   

 242   3              }
 243   2        //     UART1_SendOneChar ( S2BUF );
 244   2          }
 245   1      
 246   1      
 247   1      
 248   1      
 249   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    336    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      3    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
